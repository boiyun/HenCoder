# TCP/IP和HTTPS

## TCP/IP 协议族
一系列协议所组成的一个网络分层模型。
分层（因为现实网络不可靠性，所以要分层）

* 应用层(Application Layer):DNS(域名服务);Http;FTP
* 传输层(Transport Layer):TCP、UDP    
    * 拆分数据和组装数据，让数据稳定传输，并不是真的传输。（保证网络数据的可靠传输）
    * TCP：会收到回执消息；
    * UDP：不管传输是否成功；（游戏、直播等）
* 网络层(Internet Layer):IP 「负责传输，解决在网络上传输包的问题，例如网络寻址、以包为单位发送网络数据」
* 数据链路层(Link Layer):以太网、Wi-Fi；为网络提供一个实际的工具（物理支持）。

## TCP 连接
### 连接

* 通信双方建立确认「可以通信」，不会将对⽅的消息丢弃，即为「建立连接」。
* 建立连接后得到Socket对象：套接字，端口
* 收消息：inputstream；发消息：outputstream

### 三次握手：
客户端：我要给你发消息了；  
服务端：嗯好，我也要给你发了；  
客户端：嗯好，我也知道了；  
### 关闭连接：
因为会一直占用资源，保留端口，所以要关闭连接。
### 四次挥手
客户端：我没有消息了；  
服务端：我知道了；  
服务端：嗯我也没有消息给你发了；  
客户端：嗯我知道了；  
### 长连接
* 连接一直不关闭；
* 手机都是在内网里，先连接基站，分配ip；
* 聊天、推送通知等需要长连接。

### 为什么要长连接?
因为移动网络并不在 Internet 中，⽽是在运营商的内网，并不具有真正的公网 IP，因此当某个 TCP连接一段时间不通信之后，⽹关会出于⽹络性能考虑⽽关闭这条 TCP连接和公⽹的连接通道，导致这个 TCP 端口不再能收到外部通信消息，即TCP 连接被动关闭。
### 实现方式：
心跳。即在⼀定间隔时间内，使用 TCP 连接发送超短⽆意义消息来让网关不能将⾃己定义为「空闲连接」，从⽽防⽌⽹关将⾃己的连接关闭。


# HTTPS
HTTP Secure   
HTTP over SSL(Secure Socket Layer)   
HTTP over TLS(Transport Layer Secure)   
SSL是TLS的前身    
> `定义：`在HTTP之下增加的一个安全层，用于保障HTTP的加密传输。   
> `工作原理：`在客户端和服务器之间用非对称加密协商出一套对称密钥，每次发送信息之前将内容加密，收到后解密，达到内容的加密传输。

### 为什么不直接⽤⾮对称加密?
⾮对称加密由于使用了复杂的数学原理，因此计算相当复杂，如果完全使用非对称加密来加密通信内容，会严重影响网络通信的性能。
## HTTPS连接 
* 就是建立TLS连接；
* HTTP-TLS-TCP-IP-数据链路层

### 连接过程：
1. Client Hello   
`附加信息：`可选的TLS版本+可选的Cipher Suite（加密套件：‘一些加密算法’（对称加密算法、非对称加密算法、Hash算法））+客户端随机数

2. Server Hello   
`附加信息：`TLS版本+Cipher Suite+服务器随机数

3. 服务器发送给客户端证书，信任建立

    * 服务器公钥(证书)   
    * 服务器主机名   
    * 服务器地区   
    * 服务器公钥(证书)的签名    
 
    * 用于验证这个公钥签名的另一个公钥（证书签发机构的公钥(证书)）
    * 证书签发机构的名字    
    * 证书签发机构的地区    
    * 证书签发机构的公钥(证书)签名   
 
    * 证书签发机构的签发机构的公钥(证书)（根证书，操作系统认证的）   
    * 根证书名字    
    * 根证书地区    

4. 客户端再产生一个随机数（Pre-master secret），用服务器证书签名一次，发给服务器;

    * 通过客户端随机数、服务器随机数和Pre-master secret，使用固定算法计算出Master secret；

    * Master secret计算出如下：
        * 客户端加密密钥
        * 服务器加密密钥
        * 客户端MAC secret
        * 服务器MAC secret

   ` MAC secret`即：HMAC secret    
   Hash-based message authenticate code    
   `本质：`带有密钥的Hash算法。类似于签名的作用，验证消息的完整性

5. 客户端通知：将使用加密通信
6. 客户端发送：Finished（将前五步加密发送给服务器）
7. 服务器通知：将使用加密通信
8. 服务器发送：Finished（将前五步加密发送给客户端）

### 在 Android 中使用 HTTPS

#### 正常情况
直接使⽤
#### 需要⾃己写证书验证过程的场景
* ⽤的是⾃签名证书(例如只⽤于内网的 https) 
* 证书信息不全，缺乏中间证书机构(可能性不大) 
* ⼿机操作系统较旧，没有安装最新加入的根证书










